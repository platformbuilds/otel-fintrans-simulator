# Gradual Cassandra disk-pressure degradation scenario
telemetry:
  service_names:
    api_gateway: "api-gateway"
    tps: "tps"
    cassandra_client: "cassandra-client"
    cassandra_node: "cassandra-node"

  metric_names:
    transactions_total: "transactions_total"
    transactions_failed_total: "transactions_failed_total"
    transaction_latency_seconds: "transaction_latency_seconds"
    transaction_amount_paisa_sum: "transaction_amount_paisa_sum"
    transaction_amount_paisa_count: "transaction_amount_paisa_count"

    # DB (Cassandra) metrics
    db_ops_total: "db_ops_total"
    db_latency_seconds: "db_latency_seconds"
    cassandra_compaction_pending_tasks: "cassandra_compaction_pending_tasks"
    cassandra_disk_pressure: "cassandra_disk_pressure"

    # JVM & GC
    jvm_memory_used_bytes: "jvm_memory_used_bytes"
    jvm_memory_max_bytes: "jvm_memory_max_bytes"
    jvm_gc_pause_seconds_sum: "jvm_gc_pause_seconds_sum"
    jvm_gc_pause_seconds_count: "jvm_gc_pause_seconds_count"

    # Node exporter / filesystem
    node_filesystem_avail_bytes: "node_filesystem_avail_bytes"
    node_filesystem_size_bytes: "node_filesystem_size_bytes"

  labels:
    org_ids: ["bank_01", "bank_02", "bank_03"]

  outputs: ["otlp"]
  endpoint: "127.0.0.1:4317"
  insecure: true

  # declare dynamic metrics so the simulator registry creates these instruments at startup
  dynamic_metrics:
    - name: cassandra_disk_pressure
      type: gauge
      dataType: float
      description: "Synthetic cassandra disk pressure (0..1)"

    - name: cassandra_compaction_pending_tasks
      type: gauge
      dataType: int
      description: "Number of pending compaction tasks"

failure:
  mode: "bursty"
  rate: 0.01
  scenarios:
    - name: "cassandra_disk_pressure_gradual"
      # give some warmup time and then pressure grows steadily for 3 minutes
      start: "10s"
      duration: "180s"
      labels:
        OrgId: ["bank_02"]
      effects:
        # synthetic signal that represents server-level disk pressure on Cassandra nodes
        - metric: "cassandra_disk_pressure"
          op: "ramp"
          step: 0.2

        # aggressively reduce available filesystem bytes (simulating disk filling up)
        - metric: "node_filesystem_avail_bytes"
          op: "scale"
          value: 0.35

        # compaction backlog grows (adds extra IO pressure)
        - metric: "cassandra_compaction_pending_tasks"
          op: "add"
          value: 5

        # Cassandra operation latency increases as disk becomes constrained
        - metric: "db_latency"
          op: "scale"
          value: 3.0

        # increased transaction latency & failures observed downstream
        - metric: "transaction_latency_seconds"
          op: "scale"
          value: 2.0

        - metric: "transactions_failed_total"
          op: "scale"
          value: 4.0
